# 쿠버네티스 RBAC(Role-Based Access Control) 설정을 자동으로 생성합니다.
# Fluent Bit이 클러스터의 로그를 읽고 메타데이터를 수집하기 위해 필수입니다.
rbac:
  create: true

# Fluent Bit 파드가 사용할 서비스 계정을 생성합니다.
serviceAccount:
  create: false


# Fluent Bit의 핵심 설정 부분입니다.
config:


  # Input 섹션: 어디서 로그를 수집할지 정의
  inputs: |
    [INPUT]
        Name              tail
        Tag               kube.*
        Path              /var/log/containers/*.log
        Parser            docker   
        DB                /var/log/flb_kube.db
        Mem_Buf_Limit     5MB

  # Filter 섹션: 수집한 로그를 어떻게 가공할지 정의
  filters: |
    [FILTER]
        Name                kubernetes
        Match               kube.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_Tag_Prefix     kube.var.log.containers.
        # 로그에 파드 이름, 네임스페이스 등 쿠버네티스 메타데이터를 추가합니다.
        Merge_Log           On
        Keep_Log            Off
        K8S-Logging.Parser  On
        K8S-Logging.Exclude Off

    # 'component: msa' 레이블을 가진 파드의 로그만 선택하기 위한 필터
    [FILTER]
        Name                rewrite_tag
        Match               kube.*
        # kubernetes.labels.component가 'msa'인 로그에 'msa.logs' 태그를 붙입니다.
        Rule                 $kubernetes['labels']['component'] ^msa$ msa.${kubernetes['labels']['app']} false
        Emitter_Name        re_emitted

  # =======================================================
  # Output 섹션: 가공된 로그를 어디로 보낼지 4정의 (가장 중요!)
  # =======================================================
  outputs: |
    [OUTPUT]
        Name            kafka
        Match           *
        Brokers         b-1.groommskcluster.3yud5y.c3.kafka.ap-northeast-2.amazonaws.com:9094,b-2.groommskcluster.3yud5y.c3.kafka.ap-northeast-2.amazonaws.com:9094
        # !!! 중요: 로그를 보낼 Kafka 토픽 이름으로 변경하세요.
        Topics          eks-app-logs
        # MSK는 TLS 통신을 사용하므로 SSL 프로토콜을 지정합니다.
        rdkafka.security.protocol   ssl
        Format          json