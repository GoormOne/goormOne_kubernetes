# ===================================================================
# 1. Loki 설정
# ===================================================================
loki:
  # Loki를 단일 프로세스(Monolithic) 모드로 실행
  deploymentMode: monolithic

  serviceAccount:
    create: false

  # Loki 애플리케이션의 내부 동작을 상세하게 정의하는 핵심 설정
  # 이 블록 전체가 'loki:' 아래에 올바르게 들여쓰기 되어야 합니다.
  config:
    auth_enabled: false
    server:
      http_listen_port: 3100
    ingester:
      lifecycler:
        address: 127.0.0.1
        ring:
          kvstore:
            store: inmemory
          replication_factor: 1
    storage_config:
      boltdb_shipper:
        active_index_directory: /data/loki/boltdb-shipper-active
        cache_location: /data/loki/boltdb-shipper-cache
        shared_store: filesystem
      filesystem:
        directory: /data/loki/chunks
    schema_config:
      configs:
        - from: 2020-10-24
          store: boltdb-shipper
          object_store: filesystem
          schema: v11
          index:
            prefix: index_
            period: 24h

# ===================================================================
# 2. Promtail 설정
# ===================================================================
promtail:
  enabled: true
  serviceAccount:
    create: false
    name: promtail-sa

  deployment:
    enabled: true
  daemonset:
    enabled: false

  config:
    clients:
      - url: http://{{ .Release.Name }}.{{ .Release.Namespace }}.svc.cluster.local:3100/loki/api/v1/push
    scrape_configs:
      - job_name: eks-msk-logs
        kafka:
          brokers:
            - "b-2.groommskcluster.3yud5y.c3.kafka.ap-northeast-2.amazonaws.com:9094"
            - "b-1.groommskcluster.3yud5y.c3.kafka.ap-northeast-2.amazonaws.com:9094"
          topics:
            - "eks-app-log"
          group_id: "loki-promtail-consumer"
          security_protocol: "SSL"
        pipeline_stages:
          - json:
              expressions:
                log: log
                stream: stream
                kubernetes: kubernetes
          - labels:
              app: kubernetes.labels.app

# ===================================================================
# 3. Grafana 설정
# ===================================================================
grafana:
  enabled: true
  replicas: 1

  securityContext:
    fsGroup: 472
    runAsUser: 472
    runAsGroup: 472

  persistence:
    enabled: true
    storageClassName: "gp2"
    size: 10Gi

  sidecar:
    datasources:
      enabled: true

  additionalDataSources:
    - name: Loki
      type: loki
      access: proxy
      url: http://loki-stack.logging.svc.cluster.local:3100
      isDefault: true
      jsonData:
        skipCheck: true

  env:
    GF_SERVER_ROOT_URL: "https://howdy1227.com/grafana/"
    GF_SERVER_SERVE_FROM_SUB_PATH: "true"